import"https://cdn.jsdelivr.net/npm/pdfkit@0.16.0/js/pdfkit.standalone.js";import"https://cdn.jsdelivr.net/npm/blob-stream-browserify@0.1.3/index.js";import{deleteDB as _,openDB as F}from"https://cdn.jsdelivr.net/npm/idb@8/+esm";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js";let y=Object.freeze({LINES:"lines",STAR:"star",NONE:"none"});var O=PDFDocument;function N(e,t){var a={},r=(t=t||1,a.scaling=e?.scaling||1,a.cardMargin=e?.cardMargin||0,a.borderMargin=e?.borderMargin||5,a.pageFormat=e?.pageFormat||"A4",a.cropMarkShape=e?.cropMarkShape||y.LINES,a.cropMarkColor=e?.cropMarkColor||"white",e?.cropMarkSize||5),i=(a.cropMarkWidth=e?.cropMarkWidth||.5,new O({size:a.pageFormat})),n=(a.doc=i,2.8346456693),r=(a.cropMarkSize=.5*r*n*t,a.pageHeight=i.page.height*t,a.pageWidth=i.page.width*t,a.borderMargin*n*t);return a.cardMargin=a.cardMargin*n*t,a.mtgWidth=63.5*a.scaling*n*t,a.mtgHeight=88.9*a.scaling*n*t,a.cornerRadius=3*e.scaling*n*t,a.xCnt=Math.floor((a.pageWidth-2*r-a.mtgWidth)/(a.mtgWidth+a.cardMargin))+1,a.yCnt=Math.floor((a.pageHeight-2*r-a.mtgHeight)/(a.mtgHeight+a.cardMargin))+1,a.marginX=(a.pageWidth-a.xCnt*(a.mtgWidth+a.cardMargin)+a.cardMargin)/2,a.marginY=(a.pageHeight-a.yCnt*(a.mtgHeight+a.cardMargin)+a.cardMargin)/2,a}var j=blobStream;function P(e){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}let R=Object.freeze({DeckLoading:"deckLoading",DeckLoaded:"deckLoaded",ViewChanged:"viewChanged",PdfCreated:"pdfCreated",PdfCreating:"pdfCreating",StorageChanged:"storageChanged",ScryfallOpened:"scryfallOpened",ScryfallClosed:"scryfallClosed",CardFlipped:"cardFlipped",CardChanged:"cardChanged",ScrollingToCard:"scrollingToCard",FilterChanged:"filterChanged",TutorialStarted:"tutorialStarted",TutorialEnded:"tutorialEnded"});class f{static get Type(){return R}static on(e,t){document.addEventListener(e,t)}static remove(e,t){document.removeEventListener(e,t)}static dispatch(e,t){document.dispatchEvent(new MessageEvent(e,{data:t}))}}var e=P(navigator.userAgent||navigator.vendor||window.opera);let t,s=Date.now();if(sessionStorage.getItem("sessionId")?s=Number(sessionStorage.getItem("sessionId")):sessionStorage.setItem("sessionId",s),e){await _("imageCacheDB");let r={};class a{static async storeImage(e,t){t={uri:e,blob:t,session:s,timestamp:(new Date).toISOString()};r[e]=t}static async getImage(e){try{var t=r[e];return null==t?null:(t.session=s,t.timestamp=(new Date).toISOString(),t.blob)}catch{return null}}static async deleteOldImages(e){var t,a=new Date;for(t in a.setDate(a.getDate()-e),r)new Date(r[t].timestamp)<a&&delete r[t]}static async clearOldSessions(){}static async getObjectStoreSize(e){return e?{totalSize:0,sessionSize:0}:0}}t=a}else{let i=await F("imageCacheDB",2,{upgrade(e,t,a,r,i){t<1&&e.createObjectStore("images",{keyPath:"uri"}).createIndex("timestamp","timestamp",{unique:!1}),t<2&&r.objectStore("images").createIndex("session","session",{unique:!1})}}),n={totalSize:0,sessionSize:0};(async()=>{let e=0,t=0,a=await i.transaction("images","readonly").objectStore("images").openCursor();for(;a;)e+=a.value.blob.length,a.value.session==s&&(t+=a.value.blob.length),a=await a.continue();n={totalSize:e,sessionSize:t},f.dispatch(f.Type.StorageChanged,n)})();class a{static async storeImage(e,t,a){a||=0;var r=i.transaction("images","readwrite").objectStore("images"),e={uri:e,blob:t,session:a,timestamp:(new Date).toISOString()};n.sessionSize+=t.length,n.totalSize+=t.length,f.dispatch(f.Type.StorageChanged,n),await r.add(e)}static async getImage(e,t){t||=0;var a=i.transaction("images","readwrite").objectStore("images");try{var r=await a.get(e);return r.session=t,r.timestamp=(new Date).toISOString(),await a.delete(e),await a.put(r),r.blob}catch{return null}}static async clearOldSessions(){var e=i.transaction("images","readwrite").objectStore("images");let t=await e.index("session").openCursor();for(;t;)t.value.session<s&&await e.delete(t.primaryKey),t=await t.continue();n.totalSize=n.sessionSize,f.dispatch(f.Type.StorageChanged,n)}static async clearAllSessions(){await i.transaction("images","readwrite").objectStore("images").clear(),n.sessionSize=0,n.totalSize=0,f.dispatch(f.Type.StorageChanged,n)}static getObjectStoreSize(e){return e?n:n.totalSize}}t=a}var a=t;let w={};class W{constructor(e){this.src=e}loadImage(){return new Promise((e,t)=>{let a=document.createElement("img");a.crossOrigin="Anonymous",a.onload=()=>e(a),a.onerror=t,a.src=this.src})}async getDataUrl(){var e;return this.dataUrl=await a.getImage(this.src),null==this.dataUrl&&(e=await this.loadImage(),this.canvas=document.createElement("canvas"),this.canvas.width=e.width,this.canvas.height=e.height,this.context=this.canvas.getContext("2d"),this.context.drawImage(e,0,0),this.cornerSize=this.canvas.width/21,this.removeBackground(),this.dataUrl=this.canvas.toDataURL("image/png"),await a.storeImage(this.src,this.dataUrl)),this.dataUrl}removeBackground(){var i=this.canvas.width,e=this.canvas.height,n=this.context.getImageData(0,0,i,e),s=this.cornerSize*this.cornerSize+2,o=i*e*4,t=Math.floor(this.cornerSize/3),d=this.getAvgColor(n,this.cornerSize-2*t,this.cornerSize-2*t,t),l=this.getAvgColor(n,i-this.cornerSize+t,this.cornerSize-2*t,t),c=this.getAvgColor(n,this.cornerSize-2*t,e-this.cornerSize+t,t),h=this.getAvgColor(n,i-this.cornerSize+t,e-this.cornerSize+t,t);for(let a=0,r=this.cornerSize;a<this.cornerSize;a++,r--)for(let e=0,t=this.cornerSize;e<this.cornerSize&&t*t+r*r>=s;e++,t--){var m=4*(e+a*i),g=4*(i-e+a*i);this.colorPixel(m,n,d),this.colorPixel(g,n,l),this.colorPixel(o-g,n,c),this.colorPixel(o-m,n,h)}this.context.putImageData(n,0,0)}getAvgColor(a,e,t,r){let i=0,n=0,s=0,o=0,d=0,l=4*(t*a.width+e);var c=4*a.width;for(let e=0;e<=r;e++,l+=c)for(let e=0,t=l;e<=r;e++,t+=4)i+=a.data[t],n+=a.data[t+1],s+=a.data[t+2],o+=a.data[t+3],d++;return[Math.floor(i/d),Math.floor(n/d),Math.floor(s/d),Math.floor(o/d)]}colorPixel(e,t,a){t.data[e]=a[0],t.data[e+1]=a[1],t.data[e+2]=a[2],t.data[e+3]=a[3]}}let S;class q{constructor(e){this.options=e,this.images=[]}addImage(e,t){this.images.push({count:e,image:t})}async create(p){let u=N(this.options),f=u.doc;return new Promise(async t=>{let a=u.doc.pipe(j());a.on("finish",function(){var e=a.toBlob("application/pdf"),e=URL.createObjectURL(e);S&&URL.revokeObjectURL(S),S=e,t(e)});var r,i,n=0,s=this.images.flatMap(e=>Array(e.count).fill(e.image)),o=s.length;let d="",l;for(;n<s.length;){0<n&&f.addPage(u.pageOptions);for(let e=0,a=u.marginY;e<u.yCnt&&n<s.length;e++,a+=u.mtgHeight+u.cardMargin)for(let e=0,t=u.marginX;e<u.xCnt&&n<s.length;e++,t+=u.mtgWidth+u.cardMargin,n++){p(n/o);var c=s[n];d!=c&&(l=(r=c,i=void 0,i=new W(r),await(null==w[r]?w[r]=i.getDataUrl():w[r])),d=c),f.image(l,t,a,{width:u.mtgWidth,height:u.mtgHeight})}var h,m,g=u.cropMarkSize/2;if(u.cropMarkShape!=y.NONE)for(let e=0,a=u.marginY;e<=u.yCnt;e++,a+=u.mtgHeight+u.cardMargin)for(let e=0,t=u.marginX;e<=u.xCnt;e++,t+=u.mtgWidth+u.cardMargin)u.cropMarkShape===y.STAR?(m=g-(h=.9*g),f.path(`M ${t-g},${a} `+`c ${h},${m} ${h},${m} ${g},${g} `+`c ${m},-${h} ${m},-${h} ${g},-${g} `+`c -${h},-${m} -${h},-${m} -${g},-${g} `+`c -${m},${h} -${m},${h} -${g},${g} `).lineWidth(0).fillColor(u.cropMarkColor),f.fill()):(y.LINES,f.lineCap("round").lineWidth(u.cropMarkWidth).moveTo(t,a-u.cropMarkSize).lineTo(t,a+u.cropMarkSize).moveTo(t-u.cropMarkSize,a).lineTo(t+u.cropMarkSize,a).stroke(u.cropMarkColor))}p(1),f.end()})}}async function i(){if(i.lastCall){let t=Date.now()-i.lastCall;t<100&&await new Promise(e=>setTimeout(e,100-t))}i.lastCall=Date.now()}let n,V;class o{static async get(e,t,a){let r;if(e&&(r="https://api.scryfall.com/cards/"+e,e=localStorage.getItem("card_"+e))&&(t=(e=JSON.parse(e)).set,a=e.nr),a){r=`https://api.scryfall.com/cards/${t}/`+a;e=localStorage.getItem(`card_${t}_`+a);if(e)return JSON.parse(e).data}await i();t=await fetch(r);return 200==t.status?(e=`card_${(a=await t.json()).set.toUpperCase()}_`+a.collector_number,localStorage.setItem(e,JSON.stringify({timestamp:Date.now(),data:a})),localStorage.setItem("card_"+a.id,JSON.stringify({timestamp:Date.now(),set:a.set.toUpperCase(),nr:a.collector_number})),a):null}static async search(e,t){var a=t?`https://api.scryfall.com/cards/search?order=name&q=${encodeURIComponent(`!"${e}" (set:${t} or set:t${t}) -is:art_series`)}&include_extras=true`:`https://api.scryfall.com/cards/search?order=name&q=${encodeURIComponent(`!"${e}" -is:art_series`)}&include_extras=true`,t=t?`card_${e}_`+t:"card_"+e,e=localStorage.getItem(t);if(e)return e=JSON.parse(e),(r=await o.get(null,e.set,e.nr)).isUndefined=e.isUndefined,r;await i();var r,e=await fetch(a);return e.ok?(r=await e.json()).total_cards<1?void console.log(r):((a=r.data[0]).isUndefined=1<r.total_cards,localStorage.setItem(t,JSON.stringify({timestamp:Date.now(),set:a.set,nr:a.collector_number,isUndefined:a.isUndefined})),localStorage.setItem(`card_${a.set.toUpperCase()}_`+a.collector_number,JSON.stringify({timestamp:Date.now(),data:r.data[0]})),a):null}static open(e,t,a,r){var i="",t=(t.isExtendedArt&&t.isFullArt?i+=" (is:extendedart or is:full)":t.isExtendedArt?i+=" is:extendedart":t.isFullArt&&(i+=" is:full"),t.frames.length&&(1==t.frames.length?i+=" frame:"+t.frames[0]:i+=` (${t.frames.map(e=>"frame:"+e).join(" or ")})`),r.isUndefined?`https://scryfall.com/search?order=name&q=${encodeURIComponent(`!"${r.searchName}" -is:art_series`)}&include_extras=true`:"https://scryfall.com/search?q=oracleid%3A"+r.oracleId);t+=encodeURIComponent(i)+"&unique=prints&as=grid&order=released",clearInterval(V),n&&!n.closed?(n.location=t,n.focus()):(r=e.screenX-e.clientX,i=e.screenY-e.clientY,n=window.open(t,"_blank","popup=true,"+`width=${a.width},`+`height=${a.height},`+`left=${a.left+r},`+"top="+(a.top+i))),V=setInterval(function(){n.closed&&(clearInterval(V),f.dispatch(f.Type.ScryfallClosed))},500),f.dispatch(f.Type.ScryfallOpened,n)}static focusPopupWindow(){n?.focus()}}let H=0,c=Object.freeze({DECKSTATS:"deckstats",MTGPRINT:"mtgprint",SCRYFALL:"scryfall"});e=Object.freeze({_1993:"1993",_1997:"1997",_2003:"2003",_2015:"2015",FUTURE:"future"});let r,d=(f.on(f.Type.ScryfallClosed,()=>{r?.elem?.classList?.remove("selected"),r=null}),[]),l=[];class v{constructor(e,t,a,r,i,n,s,o){H++,this.count=e,this.format=t,this.set=a,this.nr=r,this.name=i,this.cardId=n,this.isToken=!1,this.oracleId=s,this.imageUri=o,this.isBasicLand=!1,this.highResImageUris=[],this.history=[],this.future=[],l.push(this)}static async handleTokens(){let e=[];for(let a of new Set(d.map(e=>e.tokenId)))if(!l.find(e=>e.cardId==a)){let t=await o.get(a);var r;l.find(e=>e.oracleId==t.oracle_id)||((r=e.find(e=>e.card.oracle_id==t.oracle_id))?r.requiredBy.push(...d.filter(e=>e.tokenId==a).map(e=>e.card)):e.push({card:t,requiredBy:d.filter(e=>e.tokenId==a).map(e=>e.card)}))}let i=l.filter(e=>e.isUndefined&&e.isToken);for(let a of e){let t=i.find(e=>e.name==a.card.name);t&&(t.updateBySetNr(a.card.set,a.card.collector_number,!1),t.isUndefined=!1,i=i.filter(e=>e!=t),e=e.filter(e=>e!=a))}return e}static getOpenedCard(){return r}getDescription(){switch(this.format){case c.MTGPRINT:return this.isUndefined&&!this.nr?this.count+" "+this.name:this.isUndefined?`${this.count} ${this.searchName} (${this.set.toUpperCase()}) `+this.nr:`${this.count} ${this.name} (${this.set.toUpperCase()}) `+this.nr;case c.SCRYFALL:return this.count+" "+this.scryfall_uri;default:return this.isUndefined&&!this.nr?this.count+" "+this.name:this.isUndefined?`${this.count} [${this.set.toUpperCase()}#${this.nr}] `+this.searchName:`${this.count} [${this.set.toUpperCase()}#${this.nr}] `+this.name}}static async parseCardText(o){let e=/^(?<count>\d+)\s+\[(?<set>\w+)#(?<nr>[\w-\u2605]+)\](\s+(?<name>.+))?$/,t=o.match(e),a=c.DECKSTATS;var d;if(t||(d=/^(?<count>\d+)\s+(?<name>.+)\s\((?<set>\w+)\)\s+(?<nr>[\w-\u2605]+)$/,a=c.MTGPRINT,t=o.match(d)),t||(d=/^(?<count>\d+)\s+(https:\/\/scryfall\.com\/card\/(?<set>\w+)\/(?<nr>[\w\-\u2605]+)\/[\w\-%()/]+)/,a=c.SCRYFALL,t=o.match(d)),!t){let e=/^(?<count>\d+)\s+\[(?<set>\w+)\](\s+(?<name>.+))?$/,t=o.match(e),a=c.DECKSTATS;t||(d=/^(?<count>\d+)\s+(?<name>.+)\s\((?<set>\w+)\)\s+$/,a=c.MTGPRINT,t=o.match(d)),t||(d=/^(?<count>\d+)\s+(?<name>.+)$/,a=c.DECKSTATS,t=o.match(d));let{count:r,name:i,set:n}=t.groups,s=new v(parseInt(r,10),a);return await s.searchByName(i,n),s}if(!t)throw new Error("Invalid card text format");let{count:r,set:i,nr:n,name:s}=t.groups,l=new v(parseInt(r,10),a);return await l.update(!1,null,i,n,s),void 0===l.isUndefined&&(l.isUndefined=!1),l}async updateById(e){await this.update(!1,e,void 0,void 0)}async updateBySetNr(e,t,a){await this.update(a||!1,void 0,e,t)}async update(e,t,a,r,i){if(a=a?.toUpperCase()){if(this.set===a&&this.nr===r)return void(this.history.length&&this.history[this.history.length-1].isUndefined&&(this.history.pop(),this.history.push({set:this.set,nr:this.nr,isUndefined:!1})))}else if(this.cardId===t)return;this.startUpdate(),e||(this.future=[],this.set&&this.nr&&this.history.push({set:this.set,nr:this.nr,isUndefined:this.isUndefined}));try{var n=await o.get(t,a,r);n?this.applyCardData(n):(this.isUndefined=!0,this.set=a,this.nr=r,this.imageUri="img/undefinedCard.svg",this.name="undefined",this.searchName=i,this.updateElem()),f.dispatch(f.Type.CardChanged,this)}finally{this.endUpdate()}}startUpdate(){null!=this.elem&&this.elem.classList.add("updating")}endUpdate(){null!=this.elem&&this.elem.classList.remove("updating")}async searchByName(e,t){try{this.searchName=e;var a=await o.search(e,t);a?(this.isUndefined=a.isUndefined,this.applyCardData(a)):(this.imageUri="img/undefinedCard.svg",this.name=e,this.isUndefined=!0,this.updateElem())}catch(e){console.error("Error updating card:",e)}}applyCardData(e){this.cardId=e.id,this.oracleId=e.oracle_id,this.highResImageUris=[],e.image_uris?(this.twoFaced=!1,this.imageUri=e.image_uris.normal,this.imageUris=[],this.highResImageUris.push(e.image_uris.large)):(this.twoFaced=!0,this.imageUris=[e.card_faces[0].image_uris.normal,e.card_faces[1].image_uris.normal],this.imageUri=this.imageUris[0],this.highResImageUris.push(e.card_faces[0].image_uris.large),this.highResImageUris.push(e.card_faces[1].image_uris.large)),this.set=e.set.toUpperCase(),this.nr=e.collector_number,this.name=e.name,this.scryfall_uri=e.scryfall_uri,this.isBasicLand=e.type_line.startsWith("Basic Land "),this.isToken=e.type_line.startsWith("Token"),!this.isToken&&e.all_parts&&e.all_parts.filter(e=>e.type_line.startsWith("Token")).forEach(e=>d.push({card:this,tokenId:e.id})),this.updateElem()}updateElem(e){null!=(e||=this.elem)&&((this.elem=e).querySelector(".cardImg").src=this.imageUri,this.twoFaced?(e.classList.add("twoFaced"),e.querySelector(".cardFlipImg").src=this.imageUris[1]):(e.classList.remove("twoFaced"),e.classList.remove("flipped")),e.classList.toggle("revertable",0<this.history.length),e.classList.toggle("forwardable",0<this.future.length),e.id="card"+this.order,e.style.zIndex||(e.style.zIndex=9e3-this.order),e.style.top=2*this.order+4+"px",e.style.bottom=2*Math.max(0,H-this.order)+4+"px",e.style.transition="bottom 1s ease-in-out",e.style.transform||(this.rotation=2*(Math.random()-.5)*2,e.style.transform=`rotate(${this.rotation}deg)`),this.observer&&this.observer.disconnect(),this.observer=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?e.target.style.zIndex=9e3-e.target.card.order:e.target.style.zIndex=1e3})},{root:document,rootMargin:`-${2*this.order+5}px 0px 0px 0px`,threshold:1}),this.observer.observe(e))}rollback(){var e;this.history.length&&(e=this.history.pop(),this.future.push({set:this.set,nr:this.nr,isUndefined:this.isUndefined}),this.updateBySetNr(e.set,e.nr,!0),this.isUndefined=e.isUndefined,this.elem.classList.toggle("revertable",0<this.history.length),this.elem.classList.add("forwardable"),f.dispatch(f.Type.CardChanged,this))}forward(){var e;this.future.length&&(e=this.future.pop(),this.history.push({set:this.set,nr:this.nr,isUndefined:this.isUndefined}),this.updateBySetNr(e.set,e.nr,!0),this.isUndefined=e.isUndefined,this.elem.classList.add("revertable"),this.elem.classList.toggle("forwardable",0<this.future.length),f.dispatch(f.Type.CardChanged,this))}openScryfall(e,t,a){null!=r&&r.elem.classList.remove("selected"),(r=this).elem.classList.add("selected"),o.open(e,t,a,this)}}let h=null,m=[],g=0,p=null,Y=0,J=!1,u=null,X=document.getElementById("prevButton"),G=document.getElementById("nextButton");class b{static start(){document.getElementById("tutorial").style.display="inherit",J=!0,f.dispatch(f.Type.TutorialStarted),g=0,this.showStep(g)}static addStep(e){m.push(e)}static get isOpen(){return J}static async showStep(e,t){h&&(h(),h=null);var{getElement:e,getFrameElement:a,text:r,continueAfter:i,canSkip:n}=m[e];let s=await e(),o=a?await a():s,d=document.getElementById("tutorialFrame");e=document.getElementById("tutorialText");if(G.disabled=!1,X.disabled=g<1,G.innerText=g<m.length-1?"Next":"Finish",p&&(p.style.zIndex=Y),s)if(e.innerHTML=r,Y=s.style.zIndex,s.style.zIndex=20001,p=s,d.style.borderRadius=parseFloat(getComputedStyle(o).borderRadius)+2+"px",clearInterval(u),u=setInterval(function(){20001!=s.style.zIndex&&(Y=s.style.zIndex),s.style.zIndex=20001;var e=o.getBoundingClientRect();d.style.top=e.top+window.scrollY+"px",d.style.left=e.left+window.scrollX+"px",d.style.width=e.width+"px",d.style.height=e.height+"px"},200),null!=i){document.getElementById("nextButton").disabled=null==n||!n();try{await i(t),clearInterval(u),await new Promise(e=>setTimeout(e,500)),await this.nextStep()}catch(e){console.log(e)}}else document.getElementById("nextButton").disabled=!1}static async nextStep(e){g<m.length-1?(g++,await this.showStep(g,e)):this.end()}static async prevStep(e){0<g&&(g--,await this.showStep(g,e))}static end(){f.dispatch(f.Type.TutorialEnded),document.getElementById("tutorial").style.display="none",g=0,u&&clearInterval(u),p&&(p.style.zIndex=""),localStorage.setItem("finishedTutorial",!0),J=!1,window.location.reload()}static waitForEvent(r,i,t){return new Promise((a,e)=>{h=e,f.on(r,function e(t){i&&i(t?.data),f.remove(r,e),h=null,a()}),t&&t()})}}let K=Object.freeze({INPUT:"input",ARTVIEW:"artview",PDF:"pdf"}),Q=K.INPUT;class k{static get Mode(){return K}static get mode(){return Q}static set mode(e){Q=e}}function I(e,t){var a,r;t||="smooth",e.elem&&(a=document.getElementById("cards"),k.mode==k.Mode.INPUT?(r=(e=>{let t=e.elem.getBoundingClientRect(),a=t.height,r=t.width,i=Math.abs(e.rotation*(Math.PI/180)),n=Math.sin(i),s=Math.cos(i);return(r*n-a*s)/(n*n-s*s)})(e),a.scrollTo({top:Math.max(0,e.order*(r+10)-a.getBoundingClientRect().height/2),behavior:t})):k.mode==k.Mode.ARTVIEW&&e.elem.scrollIntoView({block:"start",behavior:t}))}let Z=!1,C=null,ee=!1,te=!1,ae=!1,re=!1,ie;function ne(e){ie=e.data}f.on(f.Type.TutorialStarted,()=>f.on(f.Type.ScryfallOpened,ne)),f.on(f.Type.TutorialEnded,()=>f.remove(f.Type.ScryfallOpened,ne)),b.addStep({getElement:()=>document.querySelector("#tutorialContent"),text:`Welcome\n<br>\n<br>You can start the tutorial again anytime, if you want.`}),b.addStep({getElement:()=>document.querySelector(".CodeMirror"),text:`Input your deck here. You can type or paste your deck list into this field. Each card should be on a new line and if no count is given, a single card is assumed.\n<br>\n<br>Your deck will be <b>automatically saved</b> and loaded again when you reload or revisit this site.\n<br>\n<br>Possible Inputs are:\n<br>\n<br> // Comments with leading "//"\n<br>\n<br> A list of cards from deckstats.net\n<br>1 [CMR#656] Vampiric Tutor\n<br>2 [TMH3#2] Eldrazi Spawn\n<br>\n<br> A link to a public deck on deckstats.net (only if it is the first and only line)\n<br>https://deckstats.net/decks/276918/3990370-rawr-from-the-dead/en\n<br>\n<br> A list of cards from mtgprint.net\n<br>1 Legion's Landing // Adanto, the First Fort (PXTC) 22\n<br>2 Vampiric Tutor (CMR) 656\n<br>\n<br> A link to a card on scryfall.com\n<br>1 https://scryfall.com/card/cmr/656/vampiric-tutor\n<br>2 https://scryfall.com/card/totc/10/zombie?utm_source=api\n<br>\n<br> Card names and count without set names. Be careful to select the correct card when the name is red. \n<br>1 Vampiric Tutor\n<br>2 Eldrazi Spawn`}),b.addStep({getElement:async()=>{var e=await fetch("placeholder.txt");return document.querySelector(".CodeMirror").CodeMirror.doc.setValue(await e.text()),document.querySelector("#loadDeck")},text:`You then continue with loading the deck. We try to recognize every card.\n<br>Set and the number of the card will be prioritized over the name.\n<br>\n<br>Entries like "1 Vampire" will be treated as unspecified as long as you do not change the card. Be careful to select the correct card you want.\n<br>\n<br>While loading, you can see the progress in the text field and the toaster in the bottom right corner.\n<br>\n<br>You can load the deck once. If you want to load another deck, press F5.\n<br>\n<br>To continue, click "Load Deck" and wait until it has finished.`,continueAfter:()=>b.waitForEvent(f.Type.DeckLoaded,()=>Z=!0),canSkip:()=>Z}),b.addStep({getElement:()=>document.querySelector("#cards"),text:`In this view, all the cards are displayed on the left.\n<br>You can scroll through them and see which card you are hovering over in the input field.\n<br>\n<br>You can also scroll to a card by clicking on its entry in the input field.\n<br>Try this next.`}),b.addStep({getElement:()=>document.querySelector(".CodeMirror"),text:"Click on an entry for a card to scroll to its position",continueAfter:()=>b.waitForEvent(f.Type.ScrollingToCard,e=>C=e),canSkip:()=>null!=C}),b.addStep({getElement:()=>document.querySelector("#"+C.elem.id),text:`You can edit a card by clicking on it.\n<br>This will open Scryfall with a matching search result.\n<br>\n<br>When a card is selected, you can drag an image from Scryfall on this page to change the currently selected card.\n<br>\n<br>You can drag an image directly from the search result or the details page of a card.\n<br>\n<br>Click on the card and change it afterward.\n    `,continueAfter:async()=>{I(document.querySelector("#"+C.elem.id).card),await b.waitForEvent(f.Type.CardChanged,()=>{ie.location=window.location,ie.close(),ee=!0})},canSkip:()=>ee}),b.addStep({getElement:()=>document.querySelector("#"+C.elem.id),getFrameElement:()=>document.querySelector("#"+C.elem.id+(C.history.length?" .rollbackSvg":" .forwardSvg")),text:`Now that you changed a card, you can go back to the previous card by using this arrow.\n<br>You can do this in both directions.\n<br>\n<br>Try changing the card this way.\n    `,continueAfter:async()=>{async function e(e){e.data.location=window.location,await new Promise(e=>setTimeout(e,500)),e.data.close()}I(document.querySelector("#"+C.elem.id).card),f.on(f.Type.ScryfallOpened,e),await b.waitForEvent(f.Type.CardChanged,()=>{f.remove(f.Type.ScryfallOpened,e),te=!0})},canSkip:()=>te}),b.addStep({getElement:()=>document.querySelector("#card3"),getFrameElement:()=>document.querySelector("#card3 .flipSvg"),text:"You can also flip two-sided cards by clicking on this arrow.",continueAfter:async()=>{async function e(e){e.data.location=window.location,await new Promise(e=>setTimeout(e,500)),e.data.close()}I(document.querySelector("#card3").card),f.on(f.Type.ScryfallOpened,e),await b.waitForEvent(f.Type.CardFlipped,()=>{f.remove(f.Type.ScryfallOpened,e),ae=!0})},canSkip:()=>ae}),b.addStep({getElement:()=>document.querySelector("#searchButtons"),text:`Next, you can try the Filters.\n<br>\n<br>Here you can change the preferred frame type and/or \n<br>the style of the artwork (full or extended art).\n<br>\n<br>The filters are only as good as the data of Scryfall, \n<br>so there are often some cards in the wrong category.\n`}),b.addStep({getElement:()=>document.querySelector("#searchButtons"),text:`\n<br>Close the popup when you are done trying.\n    `,continueAfter:async e=>{var t=document.querySelector("#card1");I(t.card),window.openScryfall(t.card,e),await b.waitForEvent(f.Type.ScryfallClosed,()=>re=!0)},canSkip:()=>re}),b.addStep({getElement:()=>document.querySelector("#artViewButton"),text:`Besides the InputView, there is the ArtView.\n<br>\n<br>Here you can see all the cards in a grid view.\n<br>Editing a card works the same way as in the InputView.\n<br>When you did not already load a deck, it will be loaded automatically.\n<br>\n<br>Take a look at the ArtView now.\n`,continueAfter:()=>b.waitForEvent(f.Type.ViewChanged,()=>{if(k.mode!=k.Mode.ARTVIEW)throw new Error("ArtView not opened")}),canSkip:()=>k.mode==k.Mode.ARTVIEW}),b.addStep({getElement:()=>document.querySelector("#cards"),getFrameElement:()=>document.querySelector("#tutorialContent"),text:"Thank you!<br>Now have fun choosing artworks \u{1f604}"});let se;class E{static show(e,t){var a=document.getElementById("toaster");document.getElementById("toasterMessage").textContent=e,a.classList.add("show"),se&&clearTimeout(se),void 0!==t&&(document.getElementById("toasterProgressBar").style.width=100*t+"%"),se=setTimeout(function(){a.classList.remove("show")},3e3)}static hide(){document.getElementById("toaster").classList.remove("show")}}let oe=CodeMirror,de=P(navigator.userAgent||navigator.vendor||window.opera),T=window.cards=[],$=!0,x=window.searchOptions={frames:[],isExtendedArt:!1,isFullArt:!1},M={scaling:1,cardMargin:0,borderMargin:5,pageFormat:"A4",cropMarkShape:y.STAR,cropMarkColor:"#ffffff",cropMarkSize:5,cropMarkWidth:.5,skipBasicLands:!0};var B=localStorage.getItem("printOptions");function U(e){var t=$,a=($=!1,console.log("printing: "+e),D.getScrollInfo());D.doc.setValue(D.doc.getValue()+"\n"+e),D.scrollTo(a.left,a.top),$=t}function le(e){e=Math.round(e/1048576*10)/10;document.getElementById("storeSizeValue").textContent=e,document.getElementById("storeSizeDisplay").style.display=10<e?"flex":"none"}function z(){var e,t=$,a=($=!1,T.filter(e=>e instanceof v)),r=T.map(e=>e.getDescription?e.getDescription():e).join("\n"),i=D.getScrollInfo();D.doc.setValue(r);for(e of a)e.isUndefined&&D.addLineClass(e.lineNr,"text","isUndefined");D.scrollTo(i.left,i.top),$=t,b.isOpen||(localStorage.setItem("deck",r),sessionStorage.setItem("deck",r))}B&&Object.assign(M,JSON.parse(B)),document.getElementById("cardSize").value=100*M.scaling,document.getElementById("cardMargin").value=M.cardMargin,document.getElementById("borderMargin").value=M.borderMargin,document.getElementById("paperFormat").value=M.pageFormat,document.getElementById("cropmarkSize").value=M.cropMarkSize,document.getElementById("cropMarkWidth").value=M.cropMarkWidth,document.getElementById("cropMarkColor").value=M.cropMarkColor,document.getElementById("skipBasicLands").checked=M.skipBasicLands,window.Events=f,window.View=k,window.Format=c,window.Frame=e,window.CropMark=y,window.Card=v,window.addEventListener("error",function(e){U(`\nError: ${e.message} at ${e.filename}:${e.lineno}:`+e.colno)}),window.addEventListener("unhandledrejection",function(e){U(`\nUnhandled rejection: `+e.reason)}),le(a.getObjectStoreSize()),f.on(f.Type.StorageChanged,e=>le(e.data.totalSize)),window.onDrop=async function(e){e.preventDefault(),o.focusPopupWindow(),U("\ndropped:\n"+e.dataTransfer.getData("text/uri-list"));var t,a=v.getOpenedCard();null!=a&&(e=e.dataTransfer.getData("text/uri-list").split("\n"))&&1==e.length&&(e=e[0],/^https:\/\/scryfall\.com\/card\/\w+\/[\w\-%]+\/[\w\-%()/]+$/.test(e)?(t=e.split("/"),await a.updateBySetNr(t[4],t[5]),a.isUndefined=!1,z()):/^https:\/\/cards\.scryfall\.io\/\w+\/\w+\/\w+\/[\w-]+\/[\w-]+\.jpg\?\d+$/.test(e)&&(t=e.split("/")[7].split(".")[0],await a.updateById(t),a.isUndefined=!1,z()))},window.parseDeck=async function(){var e=D.doc.getValue();if(f.dispatch(f.Type.DeckLoading),""!==e.trim()&&!document.getElementById("loadDeck").disabled){document.getElementById("loadDeck").disabled=!0,D.disabled=!0;for(var i=document.getElementById("cardTemplate"),n=document.getElementById("cardContainer");n.lastChild&&"none"!==n.lastChild.style?.display;)n.removeChild(n.lastChild);var s=e.match(/^https:\/\/deckstats\.net\/decks\/(?<userId>\d+)\/(?<deckId>\d+)-/);if(s){var{userId:s,deckId:o}=s.groups;try{D.doc.setValue(await(async(e,t)=>{e=await fetch(`https://deckstats.net/api.php?action=get_deck&id_type=saved&owner_id=${e}&id=${t}&response_type=json`),t=await e.json();var a=localStorage.getItem("deckstatSets");function r(e){return e.set_id?e.collector_number?`${e.amount} [${a[e.set_id].abbreviation}#${e.collector_number}] `+e.name:`${e.amount} [${a[e.set_id].abbreviation}] `+e.name:e.amount+" "+e.name}a?a=JSON.parse(a):(e=await(await fetch("deckstats_sets.json")).json(),a=e,localStorage.setItem("deckstatSets",JSON.stringify(a)));let i=t.sections.map(e=>(e.name&&"Main"!=e.name?`\n// ${e.name}\n`:"")+e.cards.map(r).join("\n")).join("\n");return 0<t?.sideboard?.length&&(i=(i+="\n\n// Sideboard\n")+t.sideboard.map(r).join("\n")),i=0<t?.tokens?.length?(i+="\n\n// Tokens\n")+t.tokens.map(r).join("\n"):i})(s,o))}catch(e){U("Deck could not be loaded; "+JSON.stringify(e.toString()))}}var d=e.split("\n");let t=0,a=!1,r=0;for(let e=0;e<d.length;e++){E.show(`Parsing card ${e+1} of ${d.length}...`,e/d.length);var l=d[e];if(""===l.trim()||l.startsWith("//"))"// Missing Tokens"==l||a?(a=!0,r++):T.push(l);else{var c=await v.parseCardText(l),l=(c.order=++t,c.lineNr=e-r,D.getLine(e)),l=(D.replaceRange(c.getDescription()+"\u2714\ufe0f",{line:e,ch:0},{line:e,ch:l.length}),i.cloneNode(!0));(l.card=c).updateElem(l),l.style.display="block";{h=void 0;m=void 0;g=void 0;p=void 0;var h=n;var m=c;var g=l;let t=!1;for(let e=0;e<h.children.length;e++){var p=h.children[e];if(p.card?.order>m.order){h.insertBefore(g,p),t=!0;break}}t||h.appendChild(g)}T.push(c)}}for(let e of T)e instanceof v&&e.updateElem();f.dispatch(f.Type.DeckLoaded),document.getElementById("convertToScryfallBtn").disabled=!1,document.getElementById("convertToMtgPrintBtn").disabled=!1,document.getElementById("convertToDeckstatsBtn").disabled=!1,D.disabled=!1;s=await v.handleTokens();if(0<s.length){T.push(""),T.push("// Missing Tokens");for(var u of s)T.push(`//1 [${u.card.set.toUpperCase()}#${u.card.collector_number}] `+u.card.name)}E.hide(),z(),f.on(f.Type.CardChanged,z),D.on("beforeSelectionChange",(e,t)=>(async(e,a)=>{if($&&0<e?.length){let t=Math.min(a.ranges[0].anchor.line,a.ranges[0].head.line);a=e.find(e=>e.lineNr>=t)||e[e.length-1];I(a),f.dispatch(f.Type.ScrollingToCard,a)}})(T,t))}},window.convertToFormat=function(e){for(var t of T)t instanceof v&&(t.format=e);z()},window.highlightDeckInput=function(e){var t=e.getDescription(),a=$;$=!1,D.setSelection({line:e.lineNr,ch:0},{line:e.lineNr,ch:t.length}),$=a},window.removeHighlightDeckInput=function(e){var t=$;$=!1,D.setSelection({line:e.lineNr,ch:0}),$=t},window.swapTo=function(t){if(t!=k.Mode.PDF||T.length){let e;switch(k.mode){case k.Mode.ARTVIEW:e=T.filter(e=>e instanceof v).find(e=>0<e.elem.getBoundingClientRect().top),document.body.classList.remove("artView");break;case k.Mode.INPUT:e=T.filter(e=>e instanceof v).find(e=>{e=e.elem.getBoundingClientRect();return e.top<=window.innerHeight/2+10&&e.bottom>=window.innerHeight/2-10});break;case k.Mode.PDF:document.body.classList.remove("pdfView")}switch(k.mode=t){case k.Mode.ARTVIEW:document.body.classList.add("artView");break;case k.Mode.PDF:document.body.classList.add("pdfView"),e=null;break;case k.Mode.INPUT:}e&&I(e,"instant"),f.dispatch(f.Type.ViewChanged,t)}},window.generatePdf=async function(){E.show("generating PDF");var e,t=new q(M);for(e of T)if(e instanceof v&&(!e.isBasicLand||!M.skipBasicLands))for(var a of e.highResImageUris)t.addImage(e.count,a);return document.getElementById("pdfContainer").classList.add("updating"),t.create(e=>E.show("generating PDF",e)).then(e=>{document.getElementById("pdfView").src=e,document.getElementById("downloadPdf").disabled=!1,document.getElementById("pdfContainer").classList.remove("updating")})},window.updatePdfCreation=function(e){Object.assign(M,e);for(var t of document.getElementById("cropMarkShapes").querySelectorAll("img"))t.classList.toggle("selected",t.dataset.value==M.cropMarkShape);localStorage.setItem("printOptions",JSON.stringify(M));var e=class{static create(r){var i=N(r,1.333),n=[];n.push('<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'),n.push(`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${i.pageWidth} ${i.pageHeight}">`),n.push('<rect fill="white" '+`width="${i.pageWidth}" height="${i.pageHeight}"></rect>`);for(let e=0,a=i.marginY;e<i.yCnt;e++,a+=i.mtgHeight+i.cardMargin)for(let e=0,t=i.marginX;e<i.xCnt;e++,t+=i.mtgWidth+i.cardMargin)n.push(`<rect fill="gray" x="${t}" y="${a}" width="${i.mtgWidth}" height="${i.mtgHeight}"></rect>`),n.push(`<rect stroke="red" stroke-width="0.3mm" fill="transparent" rx="${i.cornerRadius}" x="${t}" y="${a}" width="${i.mtgWidth}" height="${i.mtgHeight}"></rect>`);var s,o,d=i.cropMarkSize/2;if(r.cropMarkShape!=y.NONE)for(let e=0,a=i.marginY;e<=i.yCnt;e++,a+=i.mtgHeight+i.cardMargin)for(let e=0,t=i.marginX;e<=i.xCnt;e++,t+=i.mtgWidth+i.cardMargin)r.cropMarkShape===y.STAR?(o=d-(s=.9*d),n.push(`<path stroke-width="0" fill="${r.cropMarkColor}" d="M ${t-d},${a} `+`c ${s},${o} ${s},${o} ${d},${d} `+`c ${o},-${s} ${o},-${s} ${d},-${d} `+`c -${s},-${o} -${s},-${o} -${d},-${d} `+`c -${o},${s} -${o},${s} -${d},${d}"></path>`)):(y.LINES,n.push(`<path stroke-width="${r.cropMarkWidth}" stroke="${r.cropMarkColor}" stroke-linecap="round" fill="transparent" `+`d="M${t},${a-d} v${i.cropMarkSize} M${t-d},${a} h${i.cropMarkSize}"></path>`));return n.push("</svg>"),{svg:n.join("\n"),corner:{x:(i.marginX+i.mtgWidth+.5*i.cardMargin)/i.pageWidth,y:(i.marginY+i.mtgHeight+.5*i.cardMargin)/i.pageHeight},scale:(i.cardMargin+4*i.cornerRadius)/i.pageWidth}}}.create(M),a="data:image/svg+xml,"+encodeURIComponent(e.svg),r=(document.getElementById("templateDisplay").src=a,document.getElementById("templateDisplayDetail"));r.src=a,r.style.setProperty("--zoom",1/e.scale),r.style.setProperty("--x",100*e.corner.x+"%"),r.style.setProperty("--y",100*e.corner.y+"%")},window.saveFile=function(e,t){var a;e&&((a=document.createElement("a")).href=e,a.download=t,a.click())};var ce=document.getElementById("allArt"),he=document.getElementById("extendedArt"),me=document.getElementById("fullArt");function ge(){me.classList.toggle("selected",x.isFullArt),he.classList.toggle("selected",x.isExtendedArt),ce.classList.toggle("selected",!(x.isFullArt||x.isExtendedArt))}window.selectAllArt=function(){var e=!(x.isFullArt||x.isExtendedArt);x.isFullArt=e,x.isExtendedArt=e,ge(),window.openScryfall()},window.selectExtendedArt=function(){x.isExtendedArt=!x.isExtendedArt,ge(),window.openScryfall()},window.selectFullArt=function(){x.isFullArt=!x.isFullArt,ge(),window.openScryfall()},window.selectFrameType=function(e,t){x.frames.includes(t)?(x.frames=x.frames.filter(e=>e!==t),e.classList.remove("selected")):(x.frames.push(t),e.classList.add("selected")),window.openScryfall()},window.openScryfall=function(e,t){(e||=v.getOpenedCard())?.openScryfall(t,x,D.display.wrapper.getBoundingClientRect())};var A,pe=Date.now()-2592e5;for(A in localStorage)A.startsWith("card_")&&JSON.parse(localStorage.getItem(A)).timestamp<pe&&localStorage.removeItem(A);B=localStorage.getItem("version");if(B){if(parseFloat(B,10)<2)for(var ue in localStorage)ue.startsWith("card_")&&localStorage.removeItem(ue)}else for(var fe in localStorage)fe.startsWith("card_")&&localStorage.removeItem(fe);localStorage.setItem("version",2),window.updatePdfCreation({});let D=oe.fromTextArea(document.getElementById("deckInput"));(async()=>{var e=sessionStorage.getItem("deck")??localStorage.getItem("deck")??await(await fetch("placeholder.txt")).text();D.doc.setValue(e),de?document.getElementById("tutorialButton").style.display="none":(window.Tutorial=b,null==localStorage.getItem("finishedTutorial")&&b.start())})();e=document.getElementById("storeSizeDisplay");let L=document.getElementById("customContextMenu");e.addEventListener("contextmenu",function(e){e.preventDefault();var t=L.getBoundingClientRect();L.style.opacity=1,L.style.pointerEvents="all",L.style.left=e.pageX-t.width+"px",L.style.top=e.pageY-t.height+"px"}),document.addEventListener("click",function(){L.style.opacity=0,L.style.pointerEvents="none"}),window.cacheClearAll=a.clearAllSessions(),window.cacheClearOld=a.clearOldSessions();
